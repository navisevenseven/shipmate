name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check bash scripts syntax
        run: |
          for f in setup/*.sh; do
            echo "Checking $f..."
            bash -n "$f" || exit 1
          done
          echo "All scripts pass syntax check"

      - name: Check SKILL.md files exist
        run: |
          EXPECTED_SKILLS="shipmate code-review project-planning sprint-analytics system-design devops"
          for skill in $EXPECTED_SKILLS; do
            if [ ! -f "skills/$skill/SKILL.md" ]; then
              echo "ERROR: Missing skills/$skill/SKILL.md"
              exit 1
            fi
            echo "OK: skills/$skill/SKILL.md"
          done

      - name: Check bootstrap files exist
        run: |
          for f in bootstrap/SOUL.md bootstrap/AGENTS.md bootstrap/data/team-context.md; do
            if [ ! -f "$f" ]; then
              echo "ERROR: Missing $f"
              exit 1
            fi
            echo "OK: $f"
          done

      - name: Verify install.sh is executable
        run: test -x setup/install.sh

      - name: Verify verify.sh is executable
        run: test -x setup/verify.sh

  plugin-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: plugin/package-lock.json

      - name: Install dependencies
        working-directory: plugin
        run: npm ci

      - name: TypeScript type check
        working-directory: plugin
        run: npx tsc --noEmit

      - name: Check plugin manifest
        run: |
          if [ ! -f "plugin/openclaw.plugin.json" ]; then
            echo "ERROR: Missing plugin/openclaw.plugin.json"
            exit 1
          fi
          echo "OK: plugin manifest exists"
